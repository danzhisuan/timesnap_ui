// å¤„ç†å„ç§æƒé™è®¤è¯æœåŠ¡

import { preferences } from '@kit.ArkData';
import { ApiService } from '../services/api.service';
import { LoginRequest, LoginResponse } from '../models/Login';
import { Context } from '@kit.AbilityKit'; // è·å–å½“å‰ context


export class AuthService {
  private apiService = new ApiService();
  private static readonly PREFS_NAME = 'dataStore'; //å­˜å‚¨åº“å

  // è·å– Preferences å®ä¾‹
  private static getPrefs(context: Context): preferences.Preferences {
    return preferences.getPreferencesSync(context, { name: AuthService.PREFS_NAME });
  }

  // ç™»å½•æ–¹æ³•ï¼Œè¿”å›ç™»å½•å“åº”æ•°æ®
  async login(email: string, password: string): Promise<LoginResponse> {
    const loginRequest: LoginRequest = {
      email,
      password,
    };
    try {
      //è·å–tokenå’Œid
      const response = await this.apiService.post<LoginRequest, LoginResponse>(
        'auth/login',
        loginRequest,
      );

      const context = getContext(this); //è·å–ä¸Šä¸‹æ–‡
      await this.saveLoginInfo(context,response);//å­˜å‚¨ æŒä¹…åŒ–

      return response;
    } catch (err) {
      console.error('ç™»å½•å¤±è´¥:', err);
      // å¦‚æœ err ä¸æ˜¯ Error å®ä¾‹ï¼ŒåŒ…è£…ä¸€ä¸‹
      if (err instanceof Error) {
        throw err;
      } else {
        throw new Error(typeof err === 'string' ? err : 'Unknown error');
      }
    }
  }

  //ä¿å­˜ç™»å½•ä¿¡æ¯æŒä¹…åŒ–
  async saveLoginInfo(context : Context, loginResponse : LoginResponse){
    const prefs = AuthService.getPrefs(context);//è·å–å®ä¾‹

    prefs.putSync('access_token',loginResponse.access_token);
    prefs.putSync('user_id',loginResponse.user_id);

    prefs.flush((err) => {
      if (err) {
        console.error(`ğŸ”´ flushå¤±è´¥: ${err.code} - ${err.message}`);
      } else {
        console.info('âœ… ç™»å½•ä¿¡æ¯å·²æŒä¹…åŒ–ä¿å­˜');
      }
    });
  }

  //è·å–Token
  static getToken(context: Context): string {
    const prefs = AuthService.getPrefs(context);
    return prefs.getSync('access_token', '') as string;
  }

  //è·å–ç”¨æˆ·Id
  static getUserId(context: Context): string {
    const prefs = AuthService.getPrefs(context);
    return prefs.getSync('user_id', '') as string;
  }

  //æ¸…é™¤ç™»å½•ä¿¡æ¯
  static clearLoginInfo(context: Context): void {
    const prefs = AuthService.getPrefs(context);
    prefs.deleteSync('access_token');
    prefs.deleteSync('user_id');
    prefs.flush((err) => {
      if (err) {
        console.error(`æ¸…é™¤å¤±è´¥: ${err.code}, ${err.message}`);
      } else {
        console.info('ç™»å½•ä¿¡æ¯å·²æ¸…é™¤');
      }
    });
  }


}
